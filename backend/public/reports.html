<!DOCTYPE html>
<html class="light" dir="rtl" lang="ar">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ©</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700;800&amp;family=Noto+Sans+Arabic:wght@300;400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="/responsive.css" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="loader.js"></script>
    <script src="mock-api.js"></script>
    <script src="/mobile-nav.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#162841",
                        "primary-hover": "#233b5c",
                        "border-color": "#d4dae2",
                        "secondary-text": "#5c6f8a",
                    },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: "Public Sans", "Noto Sans Arabic", sans-serif;
        }

        #print-container {
            display: none;
        }

        @media print {
            @page {
                size: A4;
                margin: 10mm;
            }

            body * {
                visibility: hidden;
            }

            #print-container,
            #print-container * {
                visibility: visible;
            }

            #print-container {
                display: block;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }

            .print-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
                font-size: 12px;
            }

            .print-table th,
            .print-table td {
                border-bottom: 1px solid #eee;
                padding: 12px 8px;
                text-align: right;
            }

            .print-table th {
                color: #5c6f8a;
                font-weight: 500;
            }

            .print-status-badge {
                padding: 4px 12px;
                border-radius: 4px;
                font-size: 11px;
                font-weight: bold;
                display: inline-block;
            }
        }

        @media print {
            @page {
                size: A4;
                margin: 10mm;
            }

            .no-print {
                display: none !important;
            }

            aside {
                display: none !important;
            }

            nav {
                display: none !important;
            }

            /* Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§Ø­Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ© */
            html,
            body {
                height: auto !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow: visible !important;
            }

            body>div,
            main,
            main>div,
            main>div>div,
            main>div>div>div {
                display: block !important;
                height: auto !important;
                margin: 0 !important;
                padding: 0 !important;
                max-width: 100% !important;
                width: 100% !important;
            }

            main {
                padding: 0 !important;
                margin: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
            }

            .print-header {
                display: flex !important;
                flex-direction: column;
                align-items: center;
                padding: 15px 0 10px 0 !important;
                margin: 0 0 10px 0 !important;
                border-bottom: 2px solid #162841;
            }

            .print-header img {
                width: 60px;
                height: 60px;
            }

            body {
                background: white !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            table {
                width: 100% !important;
                font-size: 11px !important;
                border-collapse: collapse !important;
                margin: 0 !important;
                page-break-inside: auto !important;
            }

            th,
            td {
                padding: 6px 4px !important;
                border: 1px solid #ddd !important;
            }

            th {
                background: #f3f4f6 !important;
            }

            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .overflow-x-auto {
                overflow: visible !important;
            }

            div[class*="rounded"],
            div[class*="shadow"] {
                box-shadow: none !important;
                border: none !important;
            }

            /* ØªØ­Ø³ÙŠÙ† Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø·ÙˆÙŠÙ„Ø© */
            tr {
                page-break-inside: avoid !important;
                page-break-after: auto !important;
            }

            thead {
                display: table-header-group !important;
            }

            tfoot {
                display: table-footer-group !important;
            }

            /* Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ padding Ø£Ùˆ margin Ù…Ù† Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª */
            .flex,
            .flex-col,
            .flex-1 {
                padding: 0 !important;
                margin: 0 !important;
            }
        }
    </style>
</head>

<body class="bg-gray-50 text-[#101418] min-h-screen flex overflow-hidden">
    <!-- Print Template (Hidden on Screen) -->
    <div id="print-container" dir="rtl">
        <!-- Header -->
        <div class="flex justify-between items-start mb-12">
            <div class="text-right">
                <div class="flex items-center gap-3 mb-2">
                    <img src="/logo.png" alt="Logo" class="w-12 h-12">
                    <div>
                        <h1 class="font-bold text-xl text-[#162841]">Ø´Ø±ÙƒØ© Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø£Ù…Ù†ÙŠØ©</h1>
                        <p class="text-[10px] text-gray-500 tracking-widest uppercase">SECURITY FIRM INC</p>
                    </div>
                </div>
            </div>
            <div class="text-left text-xs text-gray-500 space-y-1" dir="ltr">
                <p><span class="font-semibold text-gray-900">Ref No:</span> <span id="print-ref">--</span></p>
                <p><span class="font-semibold text-gray-900">Date:</span> <span id="print-date-top">--</span></p>
                <p><span class="font-semibold text-gray-900">By:</span> <span id="print-user">--</span></p>
            </div>
        </div>

        <!-- Title -->
        <div class="text-center mb-8 relative">
            <h2 class="text-2xl font-bold text-[#162841] inline-block pb-2 border-b-4 border-blue-600">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª
                ÙˆØ§Ù„Ø¬ÙˆÙ„Ø§Øª Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ©</h2>
        </div>

        <!-- Filters -->
        <div class="mb-6 flex gap-8 text-xs text-gray-600 border p-3 rounded-lg bg-gray-50">
            <p><strong>Ø§Ù„ÙØªØ±Ø© Ù…Ù†:</strong> <span id="print-from">--</span></p>
            <p><strong>Ø¥Ù„Ù‰:</strong> <span id="print-to">--</span></p>
            <p><strong>Ø§Ù„Ù…ÙˆØ¸Ù:</strong> <span id="print-filter-user">Ø§Ù„ÙƒÙ„</span></p>
        </div>

        <!-- Table -->
        <table class="print-table w-full">
            <thead>
                <tr>
                    <th class="w-12">Ù….</th>
                    <th>Ø§Ù„ÙˆÙ‚Øª</th>
                    <th>Ø§Ù„Ø¬Ù‡Ø© / Ø§Ø³Ù… Ø§Ù„Ø²Ø§Ø¦Ø±</th>
                    <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªÙØµÙŠÙ„ÙŠØ©</th>
                </tr>
            </thead>
            <tbody id="print-table-body">
                <!-- Rows will be injected here -->
            </tbody>
        </table>

        <!-- Footer -->
        <div class="mt-20 pt-8 border-t border-gray-100">
            <h3 class="font-bold text-lg mb-8 text-right">Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Øª ÙˆØ§Ù„ØªÙˆØ§Ù‚ÙŠØ¹</h3>
            <div class="flex justify-around items-end text-center px-12">
                <div class="flex flex-col items-center gap-4">
                    <div class="h-24 flex items-end pb-2 border-b border-gray-300 w-64 justify-center">
                        <!-- Empty Signature Line -->
                    </div>
                    <div>
                        <p class="font-bold text-sm">ØªÙˆÙ‚ÙŠØ¹ Ø­Ø§Ø±Ø³ Ø§Ù„Ø£Ù…Ù†</p>
                        <p class="text-[10px] text-gray-500 uppercase">Security Guard Signature</p>
                    </div>
                </div>

                <div class="flex flex-col items-center gap-4">
                    <div class="h-24 flex items-end pb-2 border-b border-gray-300 w-64 justify-center">
                        <!-- Empty Signature Line -->
                    </div>
                    <div>
                        <p class="font-bold text-sm">Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…Ø´Ø±Ù</p>
                        <p class="text-[10px] text-gray-500 uppercase">Supervisor Approval</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Disclaimer -->
        <div class="mt-12 text-center text-[8px] text-gray-400">
            <p>Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø³Ø±ÙŠ ÙˆÙŠØ®Øµ Ø´Ø±ÙƒØ© Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø£Ù…Ù†ÙŠØ© ÙÙ‚Ø·. Ø£ÙŠ ØªØ¯Ø§ÙˆÙ„ ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ù‡ ÙŠØ¹Ø±Ø¶ Ù„Ù„Ù…Ø³Ø§Ø¡Ù„Ø© Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©.</p>
            <p class="mt-1" dir="ltr">This document is confidential. Generated by Security Management System v2.4</p>
        </div>
    </div>

    <div class="flex h-screen w-full">
        <aside class="w-64 bg-primary flex flex-col shrink-0 h-screen sticky top-0">
            <div class="p-6 border-b border-white/10">
                <div class="flex items-center gap-3">
                    <img src="/logo.png" alt="FAJ" class="w-12 h-12 object-contain bg-white/10 rounded-lg p-1" />
                    <div>
                        <h1 class="text-white font-bold text-lg">FAJ Security</h1>
                        <p class="text-blue-300 text-xs">Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù…Ù† Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ</p>
                    </div>
                </div>
            </div>
            <nav class="flex-1 py-4 px-3 space-y-1 overflow-y-auto">
                <a class="flex items-center gap-3 px-4 py-3 rounded-lg text-blue-200 hover:bg-white/10 hover:text-white transition-colors"
                    href="/dashboard.html">
                    <span class="material-symbols-outlined">dashboard</span>
                    <span class="font-medium">Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</span>
                </a>
                <a class="flex items-center gap-3 px-4 py-3 rounded-lg text-blue-200 hover:bg-white/10 hover:text-white transition-colors"
                    href="/visitors.html">
                    <span class="material-symbols-outlined">badge</span>
                    <span class="font-medium">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø²ÙˆØ§Ø±</span>
                </a>
                <a class="flex items-center gap-3 px-4 py-3 rounded-lg text-blue-200 hover:bg-white/10 hover:text-white transition-colors"
                    href="/patrols.html">
                    <span class="material-symbols-outlined">local_police</span>
                    <span class="font-medium">Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ©</span>
                </a>
                <a class="flex items-center gap-3 px-4 py-3 rounded-lg bg-white/15 text-white border-r-4 border-secondary"
                    href="#">
                    <span class="material-symbols-outlined">analytics</span>
                    <span class="font-bold">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
                </a>
                <a id="admin-link"
                    class="hidden flex items-center gap-3 px-4 py-3 rounded-lg text-yellow-300 hover:bg-white/10 hover:text-yellow-200 transition-colors"
                    href="/users.html">
                    <span class="material-symbols-outlined">manage_accounts</span>
                    <span class="font-medium">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø±Ø§Ø³</span>
                </a>
            </nav>
            <div class="p-4 border-t border-white/10">
                <button onclick="logout()"
                    class="w-full flex items-center justify-center gap-2 text-red-300 hover:text-red-200 hover:bg-white/5 py-2 rounded-lg transition-colors">
                    <span class="material-symbols-outlined text-[20px]">logout</span>
                    <span class="text-sm font-medium">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto bg-gray-50 relative w-full">
            <!-- Header -->
            <header
                class="h-16 bg-white border-b border-border-color flex items-center justify-between px-6 shrink-0 no-print">
                <div>
                    <h2 class="text-lg font-bold text-primary">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
                    <p class="text-xs text-gray-500" id="current-date">--</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="text-right hidden sm:block">
                        <p class="text-sm font-bold text-gray-900" id="user-name">--</p>
                        <p class="text-xs text-gray-500" id="user-role">--</p>
                    </div>
                    <div id="user-avatar"
                        class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center font-bold">
                        <span class="material-symbols-outlined">person</span>
                    </div>
                </div>
            </header>


            <div class="flex flex-col w-full h-full">
                <div class="flex flex-1 justify-center py-6 px-4 md:px-8">
                    <div class="w-full max-w-[1400px] flex flex-col">
                        <div
                            class="no-print flex flex-col md:flex-row justify-between items-start md:items-end gap-6 mb-8 border-b border-border-color pb-6">
                            <div class="flex flex-col gap-2">
                                <h1
                                    class="text-[#101418] text-3xl md:text-4xl font-black leading-tight tracking-[-0.02em]">
                                    ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø­ÙˆØ§Ø¯Ø« ÙˆØ§Ù„Ø¯ÙˆØ±ÙŠØ§Øª</h1>
                                <p class="text-secondary-text text-base font-normal">Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ© ÙˆØªØµØ¯ÙŠØ±
                                    Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©.</p>
                            </div>
                            <div class="flex gap-3 no-print">
                                <button onclick="printReport()"
                                    class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 border border-border-color bg-white hover:bg-gray-50 text-[#101418] text-sm font-bold transition-all shadow-sm group">
                                    <span
                                        class="material-symbols-outlined text-[20px] ml-2 text-secondary-text group-hover:text-primary">print</span>
                                    <span class="truncate">Ø·Ø¨Ø§Ø¹Ø© (A4)</span>
                                </button>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl border border-border-color p-5 mb-6 shadow-sm no-print">
                            <div class="flex items-center gap-2 mb-4">
                                <span class="material-symbols-outlined text-primary">filter_alt</span>
                                <h3 class="text-[#101418] text-base font-bold">ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                                <label class="flex flex-col gap-1.5 flex-1">
                                    <span class="text-[#101418] text-sm font-semibold">Ù…Ù† ØªØ§Ø±ÙŠØ®</span>
                                    <input id="from-date"
                                        class="w-full h-11 rounded-lg border border-border-color bg-gray-50 px-3 text-[#101418] text-sm focus:border-primary outline-none"
                                        type="date" />
                                </label>
                                <label class="flex flex-col gap-1.5 flex-1">
                                    <span class="text-[#101418] text-sm font-semibold">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</span>
                                    <input id="to-date"
                                        class="w-full h-11 rounded-lg border border-border-color bg-gray-50 px-3 text-[#101418] text-sm focus:border-primary outline-none"
                                        type="date" />
                                </label>
                                <label class="flex flex-col gap-1.5 flex-1 hidden" id="user-filter-container">
                                    <span class="text-[#101418] text-sm font-semibold">Ø§Ù„Ù…ÙˆØ¸Ù</span>
                                    <select id="user-filter"
                                        class="w-full h-11 rounded-lg border border-border-color bg-gray-50 px-3 text-[#101418] text-sm focus:border-primary outline-none">
                                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>
                                    </select>
                                </label>
                                <button onclick="applyFilter()"
                                    class="bg-primary hover:bg-primary-hover text-white text-sm font-bold rounded-lg px-6 h-11 shadow-sm transition-all text-nowrap">ØªØ·Ø¨ÙŠÙ‚
                                    Ø§Ù„ØªØµÙÙŠØ©</button>
                            </div>
                        </div>
                        <div
                            class="bg-white rounded-xl border border-border-color shadow-sm overflow-hidden flex flex-col mb-8">
                            <div
                                class="px-5 py-4 border-b border-border-color flex justify-between items-center bg-gray-50/50">
                                <h4 class="font-bold text-[#101418] text-sm" id="results-count">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« (-- Ø³Ø¬Ù„)
                                </h4>
                                <button onclick="loadReports()"
                                    class="p-1.5 rounded hover:bg-gray-200 text-secondary-text" title="Refresh">
                                    <span class="material-symbols-outlined text-[20px]">refresh</span>
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-right border-collapse">
                                    <thead>
                                        <tr class="bg-gray-50 border-b border-border-color">
                                            <th
                                                class="py-3 px-5 text-xs font-bold uppercase tracking-wider text-secondary-text whitespace-nowrap">
                                                Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</th>
                                            <th
                                                class="py-3 px-5 text-xs font-bold uppercase tracking-wider text-secondary-text whitespace-nowrap">
                                                Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¯Ø«</th>
                                            <th
                                                class="py-3 px-5 text-xs font-bold uppercase tracking-wider text-secondary-text whitespace-nowrap">
                                                Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
                                            <th
                                                class="py-3 px-5 text-xs font-bold uppercase tracking-wider text-secondary-text whitespace-nowrap">
                                                Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                                            <th
                                                class="py-3 px-5 text-xs font-bold uppercase tracking-wider text-secondary-text whitespace-nowrap">
                                                Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                            <th
                                                class="py-3 px-5 text-xs font-bold uppercase tracking-wider text-secondary-text min-w-[200px]">
                                                Ø§Ù„ÙˆØµÙ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="reports-table" class="bg-white divide-y divide-border-color">
                                        <tr>
                                            <td colspan="6" class="py-8 text-center text-gray-400">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„
                                                Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div
                                class="bg-gray-50 border-t border-border-color px-5 py-3 flex items-center justify-between no-print">
                                <span class="text-xs text-secondary-text font-medium" id="pagination-info">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = '/api';
        let token = localStorage.getItem('token');
        let user = JSON.parse(localStorage.getItem('user') || '{}');
        let allReportsForPrint = [];

        if (!token) window.location.href = '/';

        // Update header
        const avatarEl = document.getElementById('user-avatar');
        if (avatarEl) {
            avatarEl.textContent = (user.full_name || '--').slice(0, 2);
        }

        // Update sidebar user info
        const userNameEl = document.getElementById('user-name');
        const userRoleEl = document.getElementById('user-role');
        if (userNameEl) {
            const roleText = {
                'admin': 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…',
                'supervisor': 'Ù…Ø´Ø±Ù',
                'guard': 'Ø±Ø¬Ù„ Ø£Ù…Ù†',
                'operations_manager': 'Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª',
                'hr_manager': 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©',
                'safety_officer': 'Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø³Ù„Ø§Ù…Ø©'
            };
            userNameEl.textContent = user.full_name || '--';
            if (userRoleEl) {
                userRoleEl.textContent = roleText[user.role] || user.role || '--';
            }
        }

        // Update current date
        const now = new Date();
        const dateEl = document.getElementById('current-date');
        if (dateEl) {
            dateEl.textContent = now.toLocaleDateString('ar-SA', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Show admin elements
        if (user.role === 'admin' || user.role === 'supervisor') {
            const adminLink = document.getElementById('admin-link');
            if (adminLink) adminLink.classList.remove('hidden');

            // Show user filter for admins/supervisors
            const userFilterContainer = document.getElementById('user-filter-container');
            if (userFilterContainer) {
                userFilterContainer.classList.remove('hidden');
                loadUsers();
            }
        }

        // Set default dates
        const today = new Date();
        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        document.getElementById('from-date').value = weekAgo.toISOString().split('T')[0];
        document.getElementById('to-date').value = today.toISOString().split('T')[0];

        function getHeaders() {
            return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };
        }

        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE}/users?limit=100`, { headers: getHeaders() });
                if (response.ok) {
                    const data = await response.json();
                    const select = document.getElementById('user-filter');
                    (data.users || []).forEach(u => {
                        const option = document.createElement('option');
                        option.value = u.id;
                        option.textContent = u.full_name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading users for filter:', error);
            }
        }

        async function loadReports() {
            const fromDate = document.getElementById('from-date').value;
            const toDate = document.getElementById('to-date').value;
            const userId = document.getElementById('user-filter')?.value;

            let url = `${API_BASE}/reports?limit=50`;
            if (fromDate) url += `&from_date=${fromDate}`;
            if (toDate) url += `&to_date=${toDate}`;
            if (userId) url += `&user_id=${userId}`;

            const tbody = document.getElementById('reports-table');

            // Show loading state
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="py-8 text-center text-gray-500">
                        <div class="flex flex-col items-center gap-2">
                            <span class="material-symbols-outlined animate-spin text-3xl">progress_activity</span>
                            <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
                        </div>
                    </td>
                </tr>
            `;

            try {
                const response = await fetch(url, { headers: getHeaders() });

                if (response.status === 401 || response.status === 403) {
                    logout();
                    return;
                }

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(`Server returned ${response.status}: ${errText}`);
                }

                const data = await response.json();
                renderReports(data.logs || []);
                document.getElementById('results-count').textContent = `Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« (${data.logs?.length || 0} Ø³Ø¬Ù„)`;
                document.getElementById('pagination-info').textContent = `Ø¹Ø±Ø¶ ${data.logs?.length || 0} Ù…Ù† Ø£ØµÙ„ ${data.pagination?.total || 0} Ø³Ø¬Ù„`;
            } catch (error) {
                console.error('Error loading reports:', error);

                // Show error message in the table
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="py-12 text-center">
                            <div class="flex flex-col items-center gap-3">
                                <span class="material-symbols-outlined text-4xl text-red-500">error</span>
                                <h3 class="text-lg font-bold text-red-600">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h3>
                                <p class="text-gray-600 max-w-md mx-auto text-sm">
                                    Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø£Ùˆ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹.
                                </p>
                                <div class="p-3 bg-red-50 rounded text-red-800 text-xs font-mono text-left w-full max-w-lg overflow-auto mt-2" dir="ltr">
                                    ${error.message}
                                </div>
                                <button onclick="loadReports()" class="mt-4 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-hover transition-colors flex items-center gap-2">
                                    <span class="material-symbols-outlined text-sm">refresh</span>
                                    <span>Ù†Ø­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        function renderReports(logs) {
            const tbody = document.getElementById('reports-table');

            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</td></tr>';
                return;
            }

            const eventTypes = {
                'visitor_entry': { icon: 'badge', color: 'text-blue-600', bg: 'bg-blue-50', text: 'Ø¯Ø®ÙˆÙ„ Ø²Ø§Ø¦Ø±' },
                'visitor_exit': { icon: 'logout', color: 'text-gray-600', bg: 'bg-gray-100', text: 'Ø®Ø±ÙˆØ¬ Ø²Ø§Ø¦Ø±' },
                'patrol': { icon: 'local_police', color: 'text-indigo-600', bg: 'bg-indigo-50', text: 'Ø¯ÙˆØ±ÙŠØ©' },
                'system': { icon: 'settings', color: 'text-gray-600', bg: 'bg-gray-100', text: 'Ù†Ø¸Ø§Ù…' }
            };

            const statusColors = {
                'completed': 'text-emerald-600',
                'success': 'text-emerald-600',
                'review': 'text-amber-600',
                'pending': 'text-orange-600'
            };

            tbody.innerHTML = logs.map(log => {
                const event = eventTypes[log.event_type] || eventTypes.system;
                const date = new Date(log.event_time);
                const statusColor = statusColors[log.status] || 'text-gray-600';

                return `
            <tr class="hover:bg-blue-50/30 transition-colors">
                <td class="py-3 px-5 text-sm font-medium text-[#101418] whitespace-nowrap">
                    <div class="flex flex-col">
                        <span>${date.toLocaleDateString('ar-SA')}</span>
                        <span class="text-secondary-text text-xs">${date.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}</span>
                    </div>
                </td>
                <td class="py-3 px-5 text-sm">
                    <div class="flex items-center gap-2">
                        <span class="material-symbols-outlined ${event.color} text-[18px]">${event.icon}</span>
                        ${event.text}
                    </div>
                </td>
                <td class="py-3 px-5 text-sm text-[#101418]">${log.user_name || '--'}</td>
                <td class="py-3 px-5 text-sm text-secondary-text">${log.location || '--'}</td>
                <td class="py-3 px-5">
                    <span class="text-xs font-bold ${statusColor} flex items-center gap-1">
                        <span class="w-1.5 h-1.5 rounded-full ${statusColor.replace('text-', 'bg-')}"></span>
                        ${log.status || '--'}
                    </span>
                </td>
                <td class="py-3 px-5 text-sm text-secondary-text max-w-[300px]">
                    <div class="flex flex-col">
                        <span>${log.description || '--'}</span>
                        ${log.patrol_notes ? `<span class="text-primary font-medium mt-1">ğŸ“ ${log.patrol_notes}</span>` : ''}
                    </div>
                </td>
            </tr>
        `;
            }).join('');
        }

        function applyFilter() {
            loadReports();
        }

        async function loadAllReportsForPrint() {
            const fromDateVal = document.getElementById('from-date').value;
            const toDateVal = document.getElementById('to-date').value;
            const userId = document.getElementById('user-filter')?.value;

            let url = `${API_BASE}/reports?limit=10000`;
            if (fromDateVal) url += `&from_date=${fromDateVal}`;
            if (toDateVal) url += `&to_date=${toDateVal}`;
            if (userId) url += `&user_id=${userId}`;

            try {
                const response = await fetch(url, { headers: getHeaders() });
                if (response.status === 401 || response.status === 403) {
                    logout();
                    return [];
                }
                const data = await response.json();
                let logs = data.logs || [];

                // Client-side fallback filtering (Ensures data is correct even if backend is cached/old)
                if (userId) {
                    logs = logs.filter(log => log.user_id == userId);
                }

                if (fromDateVal && toDateVal) {
                    const start = new Date(fromDateVal + 'T00:00:00').getTime();
                    const end = new Date(toDateVal + 'T23:59:59').getTime();
                    logs = logs.filter(log => {
                        const time = new Date(log.event_time).getTime();
                        return time >= start && time <= end;
                    });
                }

                return logs;
            } catch (error) {
                console.error('Error loading all reports:', error);
                return [];
            }
        }

        async function printReport() {
            // 1. Prepare Data
            allReportsForPrint = await loadAllReportsForPrint();
            const fromDateProp = document.getElementById('from-date').value;
            const toDateProp = document.getElementById('to-date').value;
            const userFilterSelect = document.getElementById('user-filter');
            const selectedUserName = userFilterSelect && userFilterSelect.value ? userFilterSelect.options[userFilterSelect.selectedIndex].text : "Ø§Ù„ÙƒÙ„";

            // 2. Populate Header Info
            const now = new Date();
            const refNo = `SEC-${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}-${Math.floor(Math.random() * 1000).toString().padStart(4, '0')}`;

            document.getElementById('print-ref').textContent = refNo;
            document.getElementById('print-date-top').textContent = now.toLocaleDateString('en-GB'); // DD/MM/YYYY
            document.getElementById('print-user').textContent = user.username || "System";
            // Removed signer name population per request

            // 3. Populate Filters
            document.getElementById('print-from').textContent = fromDateProp || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
            document.getElementById('print-to').textContent = toDateProp || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
            document.getElementById('print-filter-user').textContent = selectedUserName;

            // 4. Populate Table
            const printTbody = document.getElementById('print-table-body');

            if (allReportsForPrint.length === 0) {
                printTbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</td></tr>';
            } else {
                const statusBadges = {
                    'completed': { text: 'Ù…ÙƒØªÙ…Ù„', bg: '#dcfce7', color: '#166534' },
                    'success': { text: 'Ù†Ø§Ø¬Ø­', bg: '#dcfce7', color: '#166534' },
                    'review': { text: 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', bg: '#fef3c7', color: '#92400e' },
                    'pending': { text: 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', bg: '#ffedd5', color: '#9a3412' }
                };

                printTbody.innerHTML = allReportsForPrint.map((log, index) => {
                    const date = new Date(log.event_time);
                    const timeStr = date.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });

                    // Determine main entity name based on event type
                    let entityName = log.visitor_name || log.visitor_company || log.user_name || "Ø§Ù„Ù†Ø¸Ø§Ù…";
                    if (log.event_type === 'patrol') entityName = "Ø¯ÙˆØ±ÙŠØ© Ù…ÙˆÙ‚Ø¹";

                    // Determine Badge
                    const status = statusBadges[log.status] || { text: log.status, bg: '#f3f4f6', color: '#4b5563' };

                    return `
                        <tr>
                            <td>${index + 1}</td>
                            <td class="font-bold font-mono" dir="ltr">${timeStr}</td>
                            <td>${entityName}</td>
                            <td>${log.location || '-'}</td>
                            <td>
                                <span class="print-status-badge" style="background-color: ${status.bg}; color: ${status.color}">
                                    ${status.text}
                                </span>
                            </td>
                            <td>
                                <div>${log.description || '-'}</div>
                                ${log.patrol_notes ? `<div class="text-[10px] text-gray-500 mt-1">${log.patrol_notes}</div>` : ''}
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            // 5. Print
            setTimeout(() => {
                window.print();
            }, 500);
        }

        function logout() {
            localStorage.clear();
            window.location.href = '/';
        }

        // Initial load
        loadReports();
    </script>
</body>

</html>