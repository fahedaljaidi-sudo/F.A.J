<!DOCTYPE html>
<html class="light" dir="rtl" lang="ar">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>لوحة المدير العام - نظام FAJ الأمني</title>
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="/responsive.css" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="loader.js"></script>
    <script src="/js/layout.js"></script>
    <script src="mock-api.js"></script>
    <script src="success-modal.js"></script>
    <script src="/mobile-nav.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#162841",
                        "primary-hover": "#233b5c",
                        "secondary": "#4C8E4D",
                        "surface": "#F5F7FA",
                        "border-color": "#e2e8f0",
                    },
                },
            },
        }
    </script>
</head>

<body data-page="super-admin" class="bg-surface text-[#101418] min-h-screen flex overflow-hidden">
    <!-- Sidebar -->
    <aside class="w-64 bg-primary flex flex-col shrink-0 h-screen sticky top-0">
        <!-- Sidebar content will be loaded by layout.js, but Super Admin might need its own or specialized version -->
        <div class="p-6 border-b border-white/10">
            <div class="flex items-center gap-3">
                <img src="/logo.png" alt="FAJ" class="w-12 h-12 object-contain bg-white/10 rounded-lg p-1" />
                <div>
                    <h1 class="text-white font-bold text-lg">FAJ Super Admin</h1>
                    <p class="text-blue-300 text-xs">إدارة المنصة</p>
                </div>
            </div>
        </div>
        <nav class="flex-1 py-4 px-3 space-y-1 overflow-y-auto">
            <a href="/super-admin.html" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg bg-white/15 text-white border-r-4 border-secondary">
                <span class="material-symbols-outlined">corporate_fare</span>
                <span class="font-bold">إدارة الشركات</span>
            </a>
            <a href="/dashboard.html" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-blue-200 hover:bg-white/10 hover:text-white transition-colors">
                <span class="material-symbols-outlined">arrow_back</span>
                <span class="font-medium">العودة للنظام</span>
            </a>
        </nav>
        <div class="p-4 border-t border-white/10">
            <button onclick="logout()" class="w-full flex items-center justify-center gap-2 text-red-300 hover:text-red-200 hover:bg-white/5 py-2 rounded-lg transition-colors">
                <span class="material-symbols-outlined text-[20px]">logout</span>
                <span class="text-sm font-medium">تسجيل الخروج</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden">
        <header class="h-16 bg-white border-b border-border-color flex items-center justify-between px-8 shrink-0">
            <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-primary text-2xl">admin_panel_settings</span>
                <h2 class="text-xl font-bold text-primary">لوحة تحكم المدير العام</h2>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="openAddModal()" class="bg-secondary hover:bg-green-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-colors">
                    <span class="material-symbols-outlined">add_business</span>
                    إضافة شركة جديدة
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8">
            <div class="max-w-6xl mx-auto space-y-6">
                <!-- Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl border border-border-color shadow-sm">
                        <p class="text-gray-500 text-sm font-bold mb-1">إجمالي الشركات</p>
                        <h3 class="text-3xl font-black text-primary" id="stat-companies">--</h3>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-border-color shadow-sm">
                        <p class="text-gray-500 text-sm font-bold mb-1">إجمالي الحراس</p>
                        <h3 class="text-3xl font-black text-secondary" id="stat-users">--</h3>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-border-color shadow-sm">
                        <p class="text-gray-500 text-sm font-bold mb-1">الاشتراكات النشطة</p>
                        <h3 class="text-3xl font-black text-blue-600" id="stat-active">--</h3>
                    </div>
                </div>

                <!-- Companies Table -->
                <div class="bg-white rounded-xl border border-border-color overflow-hidden">
                    <div class="px-6 py-4 bg-gray-50 border-b border-border-color">
                        <h3 class="font-bold text-gray-900 flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">list</span>
                            قائمة الشركات المسجلة
                        </h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-right">
                            <thead class="bg-gray-50 border-b border-border-color">
                                <tr>
                                    <th class="px-6 py-3 font-bold text-gray-600">اسم الشركة</th>
                                    <th class="px-6 py-3 font-bold text-gray-600">الكود</th>
                                    <th class="px-6 py-3 font-bold text-gray-600">الاشتراك</th>
                                    <th class="px-6 py-3 font-bold text-gray-600">تاريخ الانتهاء</th>
                                    <th class="px-6 py-3 font-bold text-gray-600">المستخدمين</th>
                                    <th class="px-6 py-3 font-bold text-gray-600">الحالة</th>
                                    <th class="px-6 py-3 font-bold text-gray-600 text-center">إجراء</th>
                                </tr>
                            </thead>
                            <tbody id="companies-table" class="divide-y divide-gray-100">
                                <tr>
                                    <td colspan="7" class="px-6 py-8 text-center text-gray-400">جاري التحميل...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Company Modal -->
    <div id="add-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden">
            <div class="p-6 border-b border-border-color bg-primary text-white flex items-center justify-between">
                <h3 class="font-bold text-lg flex items-center gap-2">
                    <span class="material-symbols-outlined">add_business</span>
                    تسجيل شركة جديدة في المنصة
                </h3>
                <button onclick="closeAddModal()" class="text-white/60 hover:text-white">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <form id="add-company-form" class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="md:col-span-2">
                    <h4 class="text-sm font-black text-gray-400 uppercase tracking-widest mb-2">بيانات المنشأة</h4>
                    <hr class="mb-4">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">اسم الشركة *</label>
                    <input type="text" id="name" required class="w-full p-3 border rounded-lg" placeholder="مثال: شركة أرامكو">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">كود الشركة (للدخول) *</label>
                    <input type="text" id="company_code" required class="w-full p-3 border rounded-lg font-bold uppercase" placeholder="مثال: ARAMCO">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">باقة الاشتراك</label>
                    <select id="subscription_plan" class="w-full p-3 border rounded-lg">
                        <option value="basic">أساسي (Basic)</option>
                        <option value="pro">احترافي (Pro)</option>
                        <option value="enterprise">مؤسسات (Enterprise)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">مدة الاشتراك (أيام)</label>
                    <input type="number" id="expiry_days" value="30" class="w-full p-3 border rounded-lg">
                </div>

                <div class="md:col-span-2 mt-4">
                    <h4 class="text-sm font-black text-gray-400 uppercase tracking-widest mb-2">حساب المدير الأول للمنشأة</h4>
                    <hr class="mb-4">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">اسم المستخدم للمدير *</label>
                    <input type="text" id="admin_username" required class="w-full p-3 border rounded-lg" placeholder="admin">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">كلمة المرور للمدير *</label>
                    <input type="password" id="admin_password" required minlength="6" class="w-full p-3 border rounded-lg" placeholder="••••••••">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-bold text-gray-700 mb-1">الاسم الكامل للمدير</label>
                    <input type="text" id="admin_full_name" required class="w-full p-3 border rounded-lg" placeholder="مثال: محمد علي">
                </div>

                <div class="md:col-span-2 pt-4">
                    <button type="submit" class="w-full py-4 bg-primary text-white rounded-lg font-bold hover:bg-primary-hover shadow-lg transition-all">
                        تفعيل الشركة وحفظ البيانات
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Company Modal -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden">
            <div class="p-6 border-b border-border-color bg-primary text-white flex items-center justify-between">
                <h3 class="font-bold text-lg flex items-center gap-2">
                    <span class="material-symbols-outlined">edit</span>
                    تعديل بيانات الشركة
                </h3>
                <button onclick="closeEditModal()" class="text-white/60 hover:text-white">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <form id="edit-company-form" class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <input type="hidden" id="edit-id">
                <div class="md:col-span-2">
                    <h4 class="text-sm font-black text-gray-400 uppercase tracking-widest mb-2">تحديث بيانات المنشأة</h4>
                    <hr class="mb-4">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">اسم الشركة *</label>
                    <input type="text" id="edit-name" required class="w-full p-3 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">باقة الاشتراك</label>
                    <select id="edit-subscription_plan" class="w-full p-3 border rounded-lg">
                        <option value="basic">أساسي (Basic)</option>
                        <option value="pro">احترافي (Pro)</option>
                        <option value="enterprise">مؤسسات (Enterprise)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">تاريخ الانتهاء</label>
                    <input type="date" id="edit-expiry_date" class="w-full p-3 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">الحد الأقصى للمستخدمين</label>
                    <input type="number" id="edit-max_users" class="w-full p-3 border rounded-lg">
                </div>

                <div class="md:col-span-2 pt-4">
                    <button type="submit" class="w-full py-4 bg-primary text-white rounded-lg font-bold hover:bg-primary-hover shadow-lg transition-all">
                        حفظ التغييرات
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = '/api/super-admin';
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!token || user.role !== 'super_admin') {
            alert('غير مصرح لك بدخول هذه الصفحة');
            window.location.href = '/dashboard.html';
        }

        async function loadCompanies() {
            try {
                const response = await fetch(`${API_BASE}/companies`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                renderCompanies(data.companies || []);
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function renderCompanies(companies) {
            const tbody = document.getElementById('companies-table');
            document.getElementById('stat-companies').textContent = companies.length;
            document.getElementById('stat-users').textContent = companies.reduce((acc, c) => acc + (parseInt(c.user_count) || 0), 0);
            document.getElementById('stat-active').textContent = companies.filter(c => c.status === 'active').length;

            if (companies.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-400">لا يوجد شركات مسجلة</td></tr>';
                return;
            }

            tbody.innerHTML = companies.map(c => `
                <tr class="hover:bg-gray-50/50">
                    <td class="px-6 py-4 font-bold text-gray-900">${c.name}</td>
                    <td class="px-6 py-4 font-mono text-blue-600 font-bold">${c.company_code}</td>
                    <td class="px-6 py-4 uppercase text-xs font-bold text-gray-500">${c.subscription_plan}</td>
                    <td class="px-6 py-4 text-xs">${new Date(c.expiry_date).toLocaleDateString('ar-SA')}</td>
                    <td class="px-6 py-4">${c.user_count} مستخدم</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded-full text-[10px] font-bold ${c.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                            ${c.status === 'active' ? 'نشط' : 'معلق'}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-center flex items-center justify-center gap-3">
                        <button onclick="openEditModal(${JSON.stringify(c).replace(/"/g, '&quot;')})" class="text-blue-600 hover:text-blue-800 flex items-center gap-1">
                            <span class="material-symbols-outlined text-sm">edit</span>
                            <span class="text-xs font-bold">تعديل</span>
                        </button>
                        <button onclick="toggleStatus(${c.id}, '${c.status}')" class="text-xs font-bold hover:underline ${c.status === 'active' ? 'text-red-500' : 'text-green-500'}">
                            ${c.status === 'active' ? 'إيقاف' : 'تفعيل'}
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function openAddModal() { document.getElementById('add-modal').classList.remove('hidden'); }
        function closeAddModal() { document.getElementById('add-modal').classList.add('hidden'); }

        document.getElementById('add-company-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                name: document.getElementById('name').value,
                company_code: document.getElementById('company_code').value,
                subscription_plan: document.getElementById('subscription_plan').value,
                expiry_days: document.getElementById('expiry_days').value,
                admin_username: document.getElementById('admin_username').value,
                admin_password: document.getElementById('admin_password').value,
                admin_full_name: document.getElementById('admin_full_name').value
            };

            try {
                const response = await fetch(`${API_BASE}/companies`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    showSuccessModal('تمت العملية', 'تم تسجيل الشركة الجديدة بنجاح');
                    closeAddModal();
                    loadCompanies();
                } else {
                    const error = await response.json();
                    alert(error.error || 'حدث خطأ');
                }
            } catch (error) {
                alert('خطأ في الاتصال');
            }
        });

        async function toggleStatus(id, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'suspended' : 'active';
            try {
                await fetch(`${API_BASE}/companies/${id}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                loadCompanies();
            } catch (error) {
                console.error(error);
            }
        }

        function openEditModal(company) {
            document.getElementById('edit-id').value = company.id;
            document.getElementById('edit-name').value = company.name;
            document.getElementById('edit-subscription_plan').value = company.subscription_plan || 'basic';
            document.getElementById('edit-max_users').value = company.max_users || 10;
            
            if (company.expiry_date) {
                const date = new Date(company.expiry_date);
                document.getElementById('edit-expiry_date').value = date.toISOString().split('T')[0];
            }
            
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
        }

        document.getElementById('edit-company-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const payload = {
                name: document.getElementById('edit-name').value,
                subscription_plan: document.getElementById('edit-subscription_plan').value,
                expiry_date: document.getElementById('edit-expiry_date').value,
                max_users: document.getElementById('edit-max_users').value
            };

            try {
                const response = await fetch(`${API_BASE}/companies/${id}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    showSuccessModal('تمت العملية', 'تم تحديث بيانات الشركة بنجاح');
                    closeEditModal();
                    loadCompanies();
                } else {
                    const error = await response.json();
                    alert(error.error || 'حدث خطأ');
                }
            } catch (error) {
                alert('خطأ في الاتصال');
            }
        });

        loadCompanies();
    </script>
</body>

</html>